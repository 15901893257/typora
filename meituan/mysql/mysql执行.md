# mysql执行

## 1.MySQL逻辑架构

<img src="/Users/dengquanliang/Library/Application%20Support/typora-user-images/image-20200703172256880.png" alt="image-20200703172256880" style="zoom: 25%;" />

**mysql架构分为Server层和存储引擎层。**

- 所有跨存储引擎功能都在Server层，如所有函数，存储过程，视图等。
- 存储引擎负责数据存储和提取。

## 2.SQL查询语句如何执行

### 2.1 Server层

#### 2.1.1 连接器

负责跟客户端建立连接、获取权限、维持和管理连接。

show processlist命令可以查看所有连接（如果有权限的话）：

<img src="/Users/dengquanliang/Library/Application%20Support/typora-user-images/image-20200703172505555.png" alt="image-20200703172505555" style="zoom: 67%;" />

Sleep表示空闲连接。

有些时候 MySQL 占用内存涨得特别快，这是因为 MySQL 在执行过程中临时使用的内存是管理在连接对象里面的，这些资源会在连接断开的时候才释放。所以如果长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM），从现象看就是 MySQL 异常重启了。

以下两种方案解决：

- 定期断开长连接。
- 如果你用的是 MySQL 5.7 或更新版本，可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection 来重新初始化连接资源。

#### 2.1.2 查询缓存

之前执行过的语句及其结果会以 key-value 对的形式，被直接缓存在内存中。key 是查询的语句，value 是查询的结果。但是**建议不使用缓存**，原因：

- 命中率低。只要有对一个表有更新，这个表上所有的查询缓存都会被清空。除非极少更新的表比较适合开缓存。（MySQL 8.0及以后已经删除查询缓存）

可以用 SQL_CACHE 显式指定查询缓存，如：select SQL_CACHE * from T where ID=10；

#### 2.1.3 分析器

词法分析：把关键字和参数等识别出来。

语法分析：判断输入的 SQL 语句是否满足 MySQL 语法。

#### 2.1.4 优化器

决定使用哪个索引，决定各个表的连接顺序。优化器阶段完成后，这个语句的执行方案就确定下来了。

#### 2.1.5 执行器

首先权限检查，然后使用引擎提供的能力拉取数据，过程是：

- 第一次调用的是“取满足条件的第一行”这个接口
- 之后循环取“满足条件的下一行”这个接口
- 直到取到这个表的最后一行。

执行器将上述遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端。

